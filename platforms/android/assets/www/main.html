<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline' *; script-src 'self'  'unsafe-inline' 'unsafe-eval' *;">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/jquerymobile/jquery.mobile-1.4.5.min.css">
        <link rel="stylesheet" href="assets/css/navbar.css">
        <link rel="stylesheet" href="assets/css/dog.css">
    </head>
    <body>
        <!--start navigator bar-->
        <div class="navbar navbar-color navbar-inverse navbar-fixed-top" role="navigation" id="slide-nav">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-toggle"> 
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="navbar-brand" style="color: white;font-size: 140%" href="#">เมนูหลัก</a>
                </div>
                <div id="slidemenu">

                    <form class="navbar-form navbar-right" role="form">
                        <div class="form-group">
                            <input type="search" placeholder="search" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-primary" >Search</button>
                    </form>

                    <ul class="nav navbar-nav">
                        <li><a href="main.html" style="font-size: 120%">หน้าหลัก</a></li>
                        <li class="dropdown"> 
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" style="font-size: 120%">ประวัติ<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="profile.html">ประวัติเจ้าของ</a></li>
                                <li><a href="dog_list.html">ประวัติสุนัข</a></li>
                            </ul>
                        </li>
                        <li><a href="article_main.html" style="font-size: 120%">บทความ</a></li>
                        <li><a href="request.html" style="font-size: 120%">ขอรับเลือด</a></li>
                        <li><a href="pm.html" style="font-size: 120%">ตั้งค่า</a></li>
                        <li><a href="questionAnswer.html" style="font-size: 120%">ถาม/ตอบ</a></li>
                        <li><a href="confirmList.html" style="font-size: 120%">confirmList</a></li>
                        <li><a href="donor_status.html" style="font-size: 120%">donor_status</a></li>
                        <li><a id="logout" href="#" style="font-size: 120%">ออกจากระบบ</a></li>
                    </ul>

                </div>
            </div>
        </div>

        <!--end navigator bar-->

        <div id="page-content">

            <div class="container" >

                <div style="height:250px; width:100%;" id="map_canvas">
                </div>
                <hr>
                <h3 class="no-margin-top">ประกาศหาเลือด</h3>

                <!--<p class="lead">Use this document as a way to quickly start any new project. All you get is this text and a mostly barebones HTML document.</p>-->

                <div id="content">
                    <ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
                        <li class="active"><a href="#all" data-toggle="tab" >ทั่วไป</a></li>
                        <li><a href="#er" data-toggle="tab">ฉุกเฉิน</a></li>
                        <li><a href="#blood" data-toggle="tab">กรุ๊ปเลือด</a></li>

                    </ul>
                    <div id="my-tab-content" class="tab-content">
                        <div class="tab-pane active" id="all">

                            <table class="table">

                                <br><tbody>
                                </tbody>
                            </table>
                        </div>


                        <div class="tab-pane" id="er">
                            <table class="table">
                                <br><tbody>
                                </tbody>
                            </table>
                        </div>


                        <div class="tab-pane" id="blood">

                            <br><label for="bloodgroup"></label>
                            <select name="bloodgroup" id="bloodgroup" style="color: black">
                                <option value="1" selected="selected">DEA 1.1</option>                        
                                <option value="2">DEA 1.2</option>
                                <option value="3">DEA 3</option>
                                <option value="4">DEA 4</option>
                                <option value="5">DEA 5</option>
                                <option value="6">DEA 6</option>
                                <option value="7">DEA 7</option>
                                <option value="8">DEA 8</option>
                                <option value="9">ไม่สามารถระบุได้</option>
                            </select>

                            <table class="table">
                                <br><tbody>
                                </tbody>
                            </table>
                        </div>

                    </div>

                </div>

                <!-- /.container -->
            </div>
            <div id="detailpage">
                <div><b>ข้อมูลผู้ขอรับบริจาคเลือด</b></div><br>
                <div id="detailcontainer">
                </div>
                <div id="detailbtn">
                    <button id="todonatebtn">บริจาค</button>
                    <button id="backbtn">กลับสู่หน้าหลัก</button>
                </div>
            </div>

            <div id="donatepage">
                <div id="donatecontainer">
                    <span>เลือกสุนัข</span>
                    <select id="choosedog" style="color: black">
                    </select>
                    <div id="reason"></div>
                </div>
                <div id="donatebtn">
                    <button id="submitbtn" disabled>ตกลง</button>
                    <button id="cancelbtn">ยกเลิก</button>
                </div>
            </div>
        </div>
        <!-- /#page-content -->
        <div id="loader">
            <img src="assets/images/loader2.gif">
        </div>
        <script src="assets/js/jquery-2.1.3.min.js"></script>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <script src="assets/jquerymobile/jquery.mobile-1.4.5.min.js"></script>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="cordova_plugins.js"></script>
        <script type="text/javascript" src="assets/js/buttonhandler.js"></script>
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
        <script src="assets/js/navbar.js"></script>
        <script>
            $(function () {
                $.support.cors = true;
                $("a").attr('data-ajax', false);
                var token = window.localStorage.getItem("token");
                var userdata = JSON.parse(window.localStorage.getItem("userdata"));
                var request_id;
                //$("#showname").html("Hello, " + userdata.firstname + " " + userdata.lastname);
                $("#detailpage").hide();
                $("#donatepage").hide();

                //Generate requests in tap pane
                $.ajax({
                    type: 'POST',
                    url: 'https://dogblooddonor.in.th/api/announce.php',
                    dataType: 'json',
                    data: {"token": token},
                    success: function (data) {
                        for (var i = 0; i < data.all.length; i++) {
                            $("#all tbody").append('<tr class="rq" data-rqid="' + data.all[i].request_id + '"><td>' + data.all[i].created_time + '</td><td>' + data.all[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + data.all[i].bloodtype_name + ' ภายในวันที่ ' + data.all[i].duedate + '</td></tr>');
                        }
                        for (var i = 0; i < data.urgent.length; i++) {
                            $("#er tbody").append('<tr class="rq" data-rqid="' + data.urgent[i].request_id + '"><td>' + data.urgent[i].created_time + '</td><td>' + data.urgent[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + data.urgent[i].bloodtype_name + ' ภายในวันที่ ' + data.urgent[i].duedate + '</td></tr>');
                        }
                        for (var i = 0; i < data.byBloodType[0].requests.length; i++) {
                            $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[0].requests[i].request_id + '"><td>' + data.byBloodType[0].requests[i].created_time + '</td><td>' + data.byBloodType[0].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + data.byBloodType[0].requests[i].bloodtype_name + ' ภายในวันที่ ' + data.byBloodType[0].requests[i].duedate + '</td></tr>');
                        }
                    }
                });

                //Show requests order by bloodgroup
                $("#bloodgroup").on("change", function () {
                    var slgroup = $("#bloodgroup").val();
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/announce.php',
                        dataType: 'json',
                        data: {"token": token},
                        success: function (data) {
                            var current = data.byBloodType;
                            $("#blood tbody").html("");
                            if (slgroup == 1) {
                                for (var i = 0; i < data.byBloodType[0].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[0].requests[i].request_id + '"><td>' + current[0].requests[i].created_time + '</td><td>' + current[0].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[0].requests[i].bloodtype_name + 'ภายในวันที่ ' + current[0].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 2) {
                                for (var i = 0; i < data.byBloodType[1].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[1].requests[i].request_id + '"><td>' + current[1].requests[i].created_time + '</td><td>' + current[1].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[1].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[1].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 3) {
                                for (var i = 0; i < data.byBloodType[2].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[2].requests[i].request_id + '"><td>' + current[2].requests[i].created_time + '</td><td>' + current[2].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[2].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[2].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 4) {
                                for (var i = 0; i < data.byBloodType[3].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[3].requests[i].request_id + '"><td>' + current[3].requests[i].created_time + '</td><td>' + current[3].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[3].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[3].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 5) {
                                for (var i = 0; i < data.byBloodType[4].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[4].requests[i].request_id + '"><td>' + current[4].requests[i].created_time + '</td><td>' + current[4].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[4].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[4].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 6) {
                                for (var i = 0; i < data.byBloodType[5].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[5].requests[i].request_id + '"><td>' + current[5].requests[i].created_time + '</td><td>' + current[5].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[5].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[5].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 7) {
                                for (var i = 0; i < data.byBloodType[6].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[6].requests[i].request_id + '"><td>' + current[6].requests[i].created_time + '</td><td>' + current[6].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[6].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[6].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 8) {
                                for (var i = 0; i < data.byBloodType[7].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[7].requests[i].request_id + '"><td>' + current[7].requests[i].created_time + '</td><td>' + current[7].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[7].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[7].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 9) {
                                for (var i = 0; i < data.byBloodType[8].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[8].requests[i].request_id + '"><td>' + current[8].requests[i].created_time + '</td><td>' + current[8].requests[i].dog_name + ' ต้องการเลือด ภายในวันที่ ' + current[8].requests[i].duedate + '</td></tr>');
                                }
                            }
                        }
                    });
                });

                //Show request detail
                $("#my-tab-content").on("click", ".rq", function () {
                    request_id = $(this).attr("data-rqid");
                    $(".container").hide();
                    $("#detailcontainer").html("");
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/get_requestdetail.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id},
                        success: function (data) {
                            $("#detailpage").fadeIn(500);
                            var detail = "";
                            detail += '<img src="https://dogblooddonor.in.th/api/userimage/' + data.requester_userprofile.user_image + '"/><br>' +
                                    '<span>รายละเอียดข้อมูลสุนัข</span><br>' +
                                    '<span>อาการ: ' + data.symptoms + '</span><br>' +
                                    '<span>สถานที่นัดพบ: ' + data.place.place_name + '</span><br>' +
                                    '<span>วันที่สิ้นสุด: ' + data.duedate + '</span><br>' +
                                    '<span>เจ้าของสุนัข: ' + data.requester_userprofile.firstname + ' ' + data.requester_userprofile.lastname + '</span><br>' +
                                    '<span>หมู่เลือด: ' + data.requester_dog.dog_bloodtype_name + '</span><br>' +
                                    '<span>ปริมาณเลือดที่ต้องการ: ' + data.amount_volume + ' CC.</span><br>';
                            $("#detailcontainer").append(detail);
                        }
                    });
                });

                //!! Donate function !!
                $("#todonatebtn").on("click", function () {
                    $("#detailpage").hide();
                    $("#choosedog").empty();
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/get_requestdetail.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id},
                        success: function (data) {
                            $("#donatepage").fadeIn(500);
                            var option = '<option></option>';
                            for (var i = 0; i < data.dog_list.length; i++) {
                                option += '<option value="' + data.dog_list[i].dog_id + '">' + data.dog_list[i].dog_name + '</option>';
                            }
                            $("#choosedog").append(option);
                        }
                    });
                });

                //!! Donate function !! - choose dog and enabled/disabled donate button
                $("#choosedog").on("change", function () {
                    var dog_id = $("#choosedog").val();
                    $("#reason").html("");
                    $("#submitbtn").attr("disabled", "disabled");
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/get_requestdetail.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id},
                        success: function (data) {
                            if (data.donateable.status == true) {
                                for (var i = 0; i < data.dog_list.length; i++) {
                                    if (data.dog_list[i].dog_id == dog_id) {
                                        if (data.dog_list[i].isOkToDonate == true) {
                                            $("#submitbtn").removeAttr("disabled");
                                        } else {
                                            for (var j = 0; j < data.dog_list[i].reasons.length; j++) {
                                                $("#reason").append(data.dog_list[i].reasons[j] + ' ');
                                            }
                                        }
                                    }
                                }
                            } else {
                                for (var i = 0; i < data.donateable.reasons.length; i++) {
                                    $("#reason").append(data.donateable.reasons[i] + ' ');
                                }
                            }
                        }
                    });
                });

                //!! Donate function !! - confirm
                $("#submitbtn").on("click", function () {
                    var dog_id = $("#choosedog").val();
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/donate_confirm.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id, "dog_id": dog_id},
                        success: function (data) {
                            if (data.result == 1) {
                                alert("จองคิวบริจาคเรียบร้อยแล้วค่ะ");
                                window.location.href = "main.html";
                            } else {
                                alert("ไม่สามารถบริจาคได้ค่ะ");
                            }
                        }
                    });
                });

                $("#backbtn").on("click", function (e) {
                    $("#detailpage").hide();
                    $(".container").fadeIn(500);
                });

                $("#cancelbtn").on("click", function (e) {
                    $("#donatepage").hide();
                    $("#detailpage").fadeIn(500);
                });

                $("#logout").on("click", function (e) {
                    $("#loader").fadeIn(500);
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/logout.php',
                        dataType: 'json',
                        data: {"token": token},
                        success: function (data) {
                            if (data.result == 1) {
                                window.localStorage.clear();
                                facebookConnectPlugin.logout();
                                document.location.href = "index.html";
                            } else {
                                alert("error");
                                $("#loader").fadeOut(500);
                            }
                        }
                    });
                });



                var mapOptions = {
                    zoom: 4,
                    center: new google.maps.LatLng(13.7563, 100.5018),
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    zoomControl: false,
                    disableDefaultUI: true
                }

                var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);



                var onSuccess = function (position) {
                    positiona = position;
                    var myLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    map.panTo(myLatLng);
                    map.setZoom(14);

                    marker = new google.maps.Marker({
                        map: map,
                        animation: google.maps.Animation.DROP,
                        position: myLatLng,
                        icon: 'assets/images/pin.png'
                    });
                };

                // onError Callback receives a PositionError object
                //
                function onError(error) {
                    alert('code: ' + error.code + '\n' +
                            'message: ' + error.message + '\n');
                }

                navigator.geolocation.getCurrentPosition(onSuccess, onError);
            });


        </script>
    </body>
</html>
