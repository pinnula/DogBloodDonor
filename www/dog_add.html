<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline' *; script-src 'self'  'unsafe-inline' 'unsafe-eval' *;">
        <meta name="viewport" content="width=device-width, user-scalable=no" />
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/css/navbar.css">
        <link rel="stylesheet" href="assets/css/dog.css">
        <link rel="stylesheet" href="assets/css/font/fonts.css">
        <style>
            .text_font{
                font-family:'Conv_THSarabunNew',sans-serif;
                font-size: 100%;
            }
        </style>
    </head>
    <body>

        <div id="page-content">

            <div class="container" >
                <form id="dogform" method="post">
                    <div id="userpic" class="userpic" style="text-align: center;">
                        <img src="assets/images/imgupload.jpg" id="userimgtag2" class="img-thumbnail img-circle" style="width: 200px;height: 200px">
                    </div>
                    <div id="userpicoverlay" style="text-align: center; display:none; overflow: hidden;
                         position: absolute; width: 100%; height:100%; top:0; left:0; z-index:10; padding-top:45%;">
                        <button type="button" class="userpicbtn btn btn-danger btn-lg" data-source="0">เลือกจากอัลบัม</button>
                        <button type="button"  class="userpicbtn btn btn-danger btn-lg" data-source="1">ถ่ายรูป</button>
                    </div>
                    <br>
                    <span style="color: red">* กรุณากรอกข้อมูลให้ครบทุกช่องค่ะ </span><br><br>
                    <input type="hidden" name="token" id="token">
                    <input type="hidden" name="dog_id" id="dog_id">
                    <input type="hidden" name="isNewDog" id="isNewDog" value="0">
                    <label for="dog_id" style="font-size: 110%">หมายเลขประจำตัวสุนัข</label>
                    <input type="text" name="dog_ids" id="dog_ids" class="text_font form-control input-lg" disabled />
                    <br>
                    <label for="dog_name" style="font-size: 110%">ชื่อสุนัข</label>
                    <input type="text" name="dog_name" id="dog_name" class="text_font form-control input-lg" required/>
                    <br>
                    <label for="dog_gendersex" style="font-size: 110%">เพศ</label>
                    <!--                        <label for="male" style="font-weight: normal">เพศผู้</label>-->
                    <div class="radio">                        
                        <label>
                            <input type="radio" name="dog_gender" id="male" value="m"> เพศผู้
                        </label>
                    </div>
                    <!--                        <label for="female" style="font-weight: normal">เพศเมีย</label>-->
                    <div class="radio">                        
                        <label>   
                            <input type="radio" name="dog_gender" id="female" value="f" > เพศเมีย
                        </label>
                    </div>
                    <br>
                    <label for="dog_birthyear" style="font-size: 110%">ปีเกิด (พ.ศ.)</label>
                    <input type="number" name="dog_birthyear" id="dog_birthyear" pattern="[0-9]{4}" min="2540" class="text_font form-control input-lg" required />
                    <br>
                    <label for="dog_weight" style="font-size: 110%">น้ำหนัก (kg.)</label>
                    <input type="number" name="dog_weight" id="dog_weight" min="1" step="any" class="text_font form-control input-lg" required />
                    <br>
                    <label for="breeds_id" style="font-size: 110%">สายพันธุ์</label>
                    <select name="breeds_id" id="breeds_id" class="form-control input-lg" style="font-size: 0.9em">
                        <option style="display:none;">--โปรดระบุ--</option>                        
                    </select>
                    <br>    
                    <label for="bloodtype_id" style="font-size: 110%">กรุ๊ปเลือด</label>
                    <select name="bloodtype_id" id="bloodtype_id" class="form-control input-lg" style="font-size: 0.9em">
                        <option style="display:none;">--โปรดระบุ--</option>                        
                        <option value="1">DEA 1.1</option>                        
                        <option value="2">DEA 1.2</option>
                        <option value="3">DEA 3</option>
                        <option value="4">DEA 4</option>
                        <option value="5">DEA 5</option>
                        <option value="6">DEA 6</option>
                        <option value="7">DEA 7</option>
                        <option value="8">DEA 8</option>
                        <option value="9">ไม่สามารถระบุได้</option>
                    </select>
                    <br>    
                    <label for="disease_id" style="font-size: 110%">โรคประจำตัว (ที่ไม่สามารถให้บริจาคเลือดได้)</label>
                    <select name="disease_id" id="disease_id" class="form-control input-lg" style="font-size: 0.9em">
                        <option style="display:none;">--โปรดระบุ--</option>                        
                        <option value="1">ไม่มี</option>                        
                        <option value="2">ไม่สามารถระบุได้</option>
                        <option value="3">โรคแท้งติดต่อ</option>
                        <option value="4">โรคหัวใจ</option>
                        <option value="5">โรคตับ</option>
                        <option value="6">โรคไต</option>
                        <option value="7">โรคผิวหนัง</option>
                        <option value="8">โรคพยาธิเม็ดเลือด</option>
                        <option value="9">โรคพยาธิหัวใจ</option>
                    </select>
                    <br>    
                    <button class="btn btn-default btn-block" type="submit" value="Submit" style="background-color: #ac2925; color: white;font-size: 1em">บันทึกข้อมูล</button> 
                    <br>
                </form>
            </div>
        </div>
        <!--        </div>-->
        <div id="loader" style="opacity: 1;">
            <img src="assets/images/loader2.gif">
            <div id="progressbar">
                <h3>Uploading</h3>
                <br>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-danger active" 
                         role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                        <span class="sr-only">45% Complete</span>
                    </div>
                </div>
            </div>
        </div>
        <script src="cordova.js"></script>
        <script src="assets/js/jquery.js"></script>
        <script src="assets/js/jquery.transit.min.js"></script>
        <script src="assets/js/base.js"></script>
        <script src="assets/js/functions.js"></script>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <script type="text/javascript">
            var userdata;
            var imguri = "";
            addNavBar();
            navBarInit();
            stroageInit();
            appInit();
            $(function () {
                setMenu("nav-user");
                setMenu("nav-doglist");
                disableBackButton();
                setTitle("เพิ่มสุนัขใหม่");
                setTimeout(function () {
                    $(".navbar-toggle").remove();
                }, 300);
                $("#loader").hide();
                
                $("#token").val(window.localStorage.getItem("token"));

                var date = new Date();
                var year = date.getFullYear();
                $("#dog_birthyear").attr("max", year + 543);

                // Generate select-option input -- Dog Breeds
                $.ajax({
                    url: 'https://dogblooddonor.in.th/api/dog_breedslist.php',
                    success: function (data) {
                        for (var i = 0; i < data.length; i++) {
                            $("#breeds_id").append('<option style="color:black" value="' + data[i].breeds_id + '">' + data[i].breeds_name + '</option>');
                        }
                        var dogdata = JSON.parse(window.localStorage.getItem("dogdata"));
                        $("#breeds_id").val(thisdog.breeds_id);
                    }
                });

                if (!checkisNew()) {
                    var dogindex = getUrlParameter("dogindex");
                    var userdata = JSON.parse(window.localStorage.getItem("userdata"));
                    var dogdata = JSON.parse(window.localStorage.getItem("dogdata"));
                    var thisdog = dogdata[dogindex];
                    $("#dog_id").val(thisdog.dog_id);
                    $("#dog_ids").val(thisdog.dog_id);
                    $("#dog_name").val(thisdog.dog_name);
                    $("#dog_gender").val(thisdog.dog_gender);
                    $("#dog_birthyear").val(thisdog.dog_birthyear);
                    $("#dog_weight").val(thisdog.dog_weight);
                    $("#disease_id").val(thisdog.disease_id);
                    $("input[name=dog_gender][value=" + thisdog.dog_gender + "]").prop('checked', true);
                    $("#bloodtype_id").val(thisdog.dog_bloodtype_id);
                    if (thisdog.dog_image != "") {
                        $("#userimgtag2").attr("src", "https://dogblooddonor.in.th/api/dogimage/" + thisdog.dog_image);
                    }
                } else {
                    $("#isNewDog").val(1);
                }
                $("#dog_ids").attr("disabled", "disabled");

                $("#userpic").on("click", function (e) {
                    $(this).css("opacity", "0.4");
                    $("#userpicoverlay").fadeIn(300);
                });

                $(".userpicbtn").on("click", function (e) {
                    navigator.camera.getPicture(onSuccess, onFail, {quality: 70,
                        destinationType: Camera.DestinationType.FILE_URI,
                        allowEdit: true,
                        encodingType: Camera.EncodingType.JPEG,
                        correctOrientation: true,
                        mediaType: 0,
                        saveToPhotoAlbum: false,
                        sourceType: $(this).attr("data-source")
                    });

                    function onSuccess(imageURI) {
                        imguri = imageURI;
                        $("#userpic").html('<img src="' + imageURI + '?timestamp=' + new Date().getTime() + '" id="userimgtag2" class="img-thumbnail img-circle" style="width: 200px;height: 200px">');
                        //$("#userimgtag2").attr("src", imageURI);
                        $("#userpic").css("opacity", "1");
                        $("#userpicoverlay").fadeOut(300);
                    }

                    function onFail(message) {
                        //alert('Image Failed because: ' + message);
                        $("#userpic").css("opacity", "1");
                        $("#userpicoverlay").fadeOut(300);
                    }
                });
                $('#dogform').submit(function () {
                    if (imguri == "") {
                        $("#loader").fadeIn(500);
                        var dataString = $("#dogform").serialize(); //DOM Object แปลงมาเป็น POST,GET
                        $.ajax({
                            type: "POST",
                            url: "https://dogblooddonor.in.th/api/dog_manage.php",
                            data: dataString,
                            dataType: 'json',
                            success: function (data) {
                                if (data.result == 0) {
                                    alert("Error");
                                    //} else if (checkisNew()) {
                                    //window.location.href = "dogprofile.html?newAccount=1";
                                } else {
                                    $.ajax({
                                        type: 'POST',
                                        url: 'https://dogblooddonor.in.th/api/checklogin.php',
                                        dataType: 'json',
                                        data: {'token': window.localStorage.getItem("token")},
                                        success: function (data) {
                                            if (data.status == 1) {
                                                window.localStorage.setItem("userdata", JSON.stringify(data.userdata));
                                                window.localStorage.setItem("dogdata", JSON.stringify(data.dogdata));
                                                alert("บันทึกข้อมูลเรียบร้อยค่ะ");
                                                window.location.href = "dog_list.html";
                                            }
                                        },
                                        error: function (data) {
                                            alert("Cannot Connect To Server :" + data);
                                        }
                                    });
                                }

                            }
                        });
                    } else {
                        var fileURL = imguri;

                        function win(r) {
                            //console.log("Code = " + r.responseCode);
                            //console.log("Response = " + r.response);
                            //console.log("Sent = " + r.bytesSent);
                            $.ajax({
                                type: 'POST',
                                url: 'https://dogblooddonor.in.th/api/checklogin.php',
                                dataType: 'json',
                                data: {'token': window.localStorage.getItem("token")},
                                success: function (data) {
                                    if (data.status == 1) {
                                        window.localStorage.setItem("userdata", JSON.stringify(data.userdata));
                                        window.localStorage.setItem("dogdata", JSON.stringify(data.dogdata));
                                        alert("บันทึกข้อมูลเรียบร้อยค่ะ");
                                        window.location.href = "dog_list.html";
                                    }
                                },
                                error: function (data) {
                                    alert("Cannot Connect To Server :" + data);
                                }
                            });
                        }

                        function fail(error) {
                            alert("An error has occurred: Code = " + error.code);
                            console.log("upload error source " + error.source);
                            console.log("upload error target " + error.target);
                        }

                        var uri = encodeURI("https://dogblooddonor.in.th/api/dog_manage.php");

                        var options = new FileUploadOptions();
                        options.fileKey = "dog_image";
                        options.fileName = fileURL.substr(fileURL.lastIndexOf('/') + 1);
                        options.mimeType = "image/jpeg";
                        options.params = {"token": $("#token").val(), "isNewDog": $("#isNewDog").val(), "breeds_id": $("#breeds_id").val(), "dog_id": $("#dog_id").val(),
                            "dog_name": $("#dog_name").val(), "dog_gender": $("input[name='dog_gender']:checked").val(), "dog_birthyear": $("#dog_birthyear").val(),
                            "bloodtype_id": $("#bloodtype_id").val(), "dog_weight": $("#dog_weight").val(), "dog_symptom": $("#dog_symptom").val(), "disease_id": $("#disease_id").val()
                        };

                        var ft = new FileTransfer();
                        ft.onprogress = function (progressEvent) {
                            if (progressEvent.lengthComputable) {
                                console.log(progressEvent.loaded / progressEvent.total);
                                $(".progress-bar").css("width", (progressEvent.loaded / progressEvent.total) * 100 + "%");
                                //loadingStatus.setPercentage(progressEvent.loaded / progressEvent.total);
                            } else {
                                //loadingStatus.increment();
                            }
                        };
                        ft.upload(fileURL, uri, win, fail, options);
                        $("#loader").fadeIn(500);
                    }
                    return false;  //stop the actual form post !important!
                });


                function checkisNew() {
                    var field = 'newDog';
                    var url = window.location.href;
                    if (url.indexOf('?' + field + '=') != -1)
                        return true;
                    else if (url.indexOf('&' + field + '=') != -1)
                        return true;
                    return false;
                }
                function getUrlParameter(sParam)
                {
                    var sPageURL = window.location.search.substring(1);
                    var sURLVariables = sPageURL.split('&');
                    for (var i = 0; i < sURLVariables.length; i++)
                    {
                        var sParameterName = sURLVariables[i].split('=');
                        if (sParameterName[0] == sParam)
                        {
                            return sParameterName[1];
                        }
                    }
                }
            });
        </script>
    </body>

</html>