<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline' *; script-src 'self'  'unsafe-inline' 'unsafe-eval' *;">
        <meta name="viewport" content="width=device-width, user-scalable=no" />
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/css/navbar.css">
        <link rel="stylesheet" href="assets/css/dog.css">
        <link rel="stylesheet" href="assets/css/font/fonts.css">
        <style>
            .text_font{
                font-family:'Conv_THSarabunNew',sans-serif;
                font-size: 100%;
            }
        </style>
    </head>
    <body>
        <div id="page-content">
            <div class="container" >
                <form id="profile" method="post">
                    <div id="userpic" class="userpic" style="text-align: center;">
                        <img src="assets/images/imgupload.jpg" id="userimgtag" class="img-thumbnail img-circle" style="width: 200px;height: 200px">
                    </div>
                    <div id="userpicoverlay" style="text-align: center; display:none; overflow: hidden;
                         position: absolute; width: 100%; height:100%; top:0; left:0; z-index:10; padding-top:45%;">
                        <button type="button" class="userpicbtn btn btn-danger btn-lg" data-source="0">เลือกจากอัลบัม</button>
                        <button type="button" class="userpicbtn btn btn-danger btn-lg" data-source="1">ถ่ายรูป</button>
                    </div>
                    <br>
                    <span style="color: red">* กรุณากรอกข้อมูลให้ครบทุกช่องค่ะ </span><br><br>
                    <input type="hidden" name="token" id="token">
                    <label for="firstname" style="font-size: 110%">ชื่อ</label>
                    <br>
                    <input type="text" name="firstname" id="firstname" class="text_font form-control input-lg" required />
                    <br>
                    <label for="lastname" style="font-size: 110%">นามสกุล</label>
                    <input type="text" name="lastname" id="lastname" class="text_font form-control input-lg" required />
                    <br>
                    <label for="address" style="font-size: 110%">ที่อยู่ </label>
                    <input type="text" name="houseno" class="text_font form-control input-lg" id="houseno" placeholder="บ้านเลขที่" required />
                    <br>
                    <label for="province_id" style="font-size: 110%">จังหวัด</label>
                    <select name="province_id" id="province_id" class="form-control input-lg" style="font-size: 0.9em" required>
                        <option style="display:none;">--โปรดระบุ--</option>
                    </select>
                    <br>
                    <label for="district_id" style="font-size: 110%">เขต/อำเภอ</label>
                    <select name="district_id" id="district_id" class="form-control input-lg" style="font-size: 0.9em" required>
                        <option style="display:none;">--โปรดระบุ--</option>
                    </select>
                    <br>
                    <label for="subdistrict_id" style="font-size: 110%">แขวง/ตำบล</label>
                    <select name="subdistrict_id" id="subdistrict_id" class="form-control input-lg" style="font-size: 0.9em" required>
                        <option style="display:none;">--โปรดระบุ--</option>
                    </select>
                    <br>
                    <label for="postcode" style="font-size: 110%">รหัสไปรษณีย์</label>
                    <input type="text" name="postcode" id="postcode" class="text_font form-control input-lg" disabled>
                    <br>
                    <label for="telno" style="font-size: 110%">เบอร์โทรศัพท์</label>
                    <input type="tel" name="telno" id="telno" class="text_font form-control input-lg" required />
                    <br>    
                    <button class="btn btn-default btn-block" type="submit" value="Submit" style="background-color: #ac2925; color: white;font-size: 1em">บันทึกข้อมูล</button> 
                    <button class="btn btn-warning btn-block" id="cancelbtn" type="button" style="display: none; color: white;font-size: 1em">ยกเลิก</button>
                    <br>

                </form>
            </div>
        </div>
        <div id="loader" style="opacity: 1;">
            <img src="assets/images/loader2.gif">
            <div id="progressbar">
                <h3>Uploading</h3>
                <br>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-danger active" 
                         role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                        <span class="sr-only">45% Complete</span>
                    </div>
                </div>
            </div>
        </div>
        <script src="cordova.js"></script>
        <script src="assets/js/jquery.js"></script>
        <script src="assets/js/jquery.transit.min.js"></script>
        <script src="assets/js/base.js"></script>
        <script src="assets/js/functions.js"></script>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <script type="text/javascript">
            var userdata;
            var imguri = "";
            addNavBar();
            navBarInit();
            appInit();
            $(function () {
                setTitle("แก้ไขประวัติผู้ใช้");
                setTimeout(function () {
                    $(".navbar-toggle").remove();
                }, 300);
                $("#loader").hide();
                disableBackButton();

                $("#token").val(window.localStorage.getItem("token"));
                if (!checkisNew()) {
                    $("#cancelbtn").show();
                    userdata = JSON.parse(window.localStorage.getItem("userdata"));
                    $("#showname").html("<b>" + userdata.firstname + " " + userdata.lastname + "</b>");
                    $("#firstname").val(userdata.firstname);
                    $("#lastname").val(userdata.lastname);
                    $("#houseno").val(userdata.address.houseno);
                    $("#postcode").val(userdata.address.postcode);
                    $("#telno").val(userdata.telno);
                    if (userdata.user_image != null) {
                        $("#userimgtag").attr("src", userimage + userdata.user_image+ '?timestamp=' + new Date().getTime());
                    } else {
                        $("#userimgtag").attr("src", "assets/images/user.png");
                    }
                }

                //Generate option menu > Province, District, Subdistrict, Postcode
                $.ajax({
                    url: api + 'user/address.php', //ที่อยู่ของไฟล์เป้าหมาย
                    type: "post",
                    dataType: "JSON",
                    success: function (data) {
                        for (var i = 0; i < data.length; i++) {
                            $("#province_id").append('<option style="color:black" value="' + data[i].province_id + '">' + data[i].province_name + '</option>');
                        }
                        if (!checkisNew()) {
                            $("#province_id").val($('#province_id option:contains("' + userdata.address.province + '")').val());
                            $("#province_id").trigger("change");
                        }
                    }
                });

                $("#province_id").on("change", function () {
                    $("#district_id").html('<option style="display:none;">--โปรดระบุ--</option>'); //ล้างข้อมูล
                    $("#subdistrict_id").html('<option style="display:none;">--โปรดระบุ--</option>'); //ล้างข้อมูล
                    $("#postcode").val(""); //ล้างข้อมูล

                    $.ajax({
                        url: api + 'user/address.php', //ที่อยู่ของไฟล์เป้าหมาย
                        type: "post", //รูปแบบข้อมูลที่จะส่ง
                        data: ({province_id: $("#province_id").val()}), //ข้อมูลที่ส่ง  { ชื่อตัวแปร : ค่าตัวแปร }
                        dataType: "JSON", //รูปแบบข้อมูลที่ส่งกลับ xml,script,json,jsonp,text
                        success: function (data) { //แสดงข้อมูลเมื่อทำงานเสร็จ 
                            for (var i = 0; i < data.length; i++) {
                                $("#district_id").append('<option style="color:black" value="' + data[i].district_id + '">' + data[i].district_name + '</option>');
                            }
                            if (!checkisNew()) {
                                $("#district_id").val($('#district_id option:contains("' + userdata.address.district + '")').val());
                                $("#district_id").trigger("change");
                            }
                        }
                    });
                });

                $("#district_id").on("change", function () {
                    $("#subdistrict_id").html('<option style="display:none;">--โปรดระบุ--</option>'); //ล้างข้อมูล
                    $("#postcode").val(""); //ล้างข้อมูล

                    $.ajax({
                        url: api + 'user/address.php', //ที่อยู่ของไฟล์เป้าหมาย
                        type: "post", //รูปแบบข้อมูลที่จะส่ง
                        data: ({province_id: $("#province_id").val(), district_id: $("#district_id").val()}), //ข้อมูลที่ส่ง  { ชื่อตัวแปร : ค่าตัวแปร }
                        dataType: "JSON", //รูปแบบข้อมูลที่ส่งกลับ xml,script,json,jsonp,text
                        success: function (data) { //แสดงข้อมูลเมื่อทำงานเสร็จ 
                            for (var i = 0; i < data.length; i++) {
                                $("#subdistrict_id").append('<option style="color:black" value="' + data[i].subdistrict_id + '">' + data[i].subdistrict_name + '</option>');
                            }
                            if (!checkisNew()) {
                                $("#subdistrict_id").val($('#subdistrict_id option:contains("' + userdata.address.subdistrict + '")').val());
                                $("#subdistrict_id").trigger("change");
                            }
                        }
                    });
                });

                $("#subdistrict_id").on("change", function () {
                    $("#postcode").val(""); //ล้างข้อมูล
                    $.ajax({
                        url: api + 'user/address.php', //ที่อยู่ของไฟล์เป้าหมาย
                        type: "post", //รูปแบบข้อมูลที่จะส่ง
                        data: ({province_id: $("#province_id").val(), district_id: $("#district_id").val(), subdistrict_id: $("#subdistrict_id").val()}), //ข้อมูลที่ส่ง  { ชื่อตัวแปร : ค่าตัวแปร }
                        dataType: "JSON", //รูปแบบข้อมูลที่ส่งกลับ xml,script,json,jsonp,text
                        success: function (data) { //แสดงข้อมูลเมื่อทำงานเสร็จ 
                            $("#postcode").val(data[0].postcode);
                        }
                    });
                });

                $("#userpic").on("click", function (e) {
                    $(this).css("opacity", "0.4");
                    $("#userpicoverlay").fadeIn(300);
                });

                $(".userpicbtn").on("click", function (e) {
                    navigator.camera.getPicture(onSuccess, onFail, {quality: 70,
                        destinationType: Camera.DestinationType.FILE_URI,
                        allowEdit: true,
                        encodingType: Camera.EncodingType.JPEG,
                        correctOrientation: true,
                        mediaType: 0,
                        saveToPhotoAlbum: false,
                        sourceType: $(this).attr("data-source")
                    });

                    function onSuccess(imageURI) {
                        imguri = imageURI;
                        $("#userpic").html('<img src="' + imageURI + '?time=' + Date.now() + '" id="userimgtag" class="img-thumbnail img-circle" style="width: 200px;height: 200px">');
                        $("#userimgtag").attr("src", imageURI + '?time=' + Date.now());
                        $("#userpic").css("opacity", "1");
                        $("#userpicoverlay").fadeOut(300);
                    }

                    function onFail(message) {
                        //alert('Image Failed because: ' + message);
                        $("#userpic").css("opacity", "1");
                        $("#userpicoverlay").fadeOut(300);
                    }
                });


                $('#profile').submit(function () {
                    if (imguri == "") {
                        $("#loader").fadeIn(500);
                        $.ajax({
                            type: "POST",
                            url: api + "user/profile_update.php",
                            data: ({"token": $("#token").val(), "firstname": $("#firstname").val(), "lastname": $("#lastname").val(),
                                "houseno": $("#houseno").val(), "sub_district": $("#subdistrict_id").val(), "district": $("#district_id").val(),
                                "province": $("#province_id").val(), "postcode": $("#postcode").val(), "telno": $("#telno").val(), "user_image": $("#userimgtag").attr("src")}),
                            dataType: 'json',
                            success: function (data) {
                                if (data.result == 0) {
                                    alert("Error");
                                } else if (checkisNew()) {
                                    window.location.href = "dog_add.html?newDog=1";
                                } else {
                                    navigator.notification.alert("บันทึกข้อมูลเรียบร้อย", function () {
                                        if (checkisNew()) {
                                            window.location.href = "dog_add.html?newDog=1&newRegis=1";
                                        } else {
                                            var options = {
                                                "direction": "down",
                                                "duration": 500, // in milliseconds (ms), default 400
                                                "androiddelay": 10, // same as above but for Android, default 70,
                                                "href": "profile.html"
                                            };
                                            window.plugins.nativepagetransitions.slide(
                                                    options
                                                    );
                                        }
                                    }, "การแก้ไขข้อมูลผู้ใช้", "ตกลง");
                                }
                            }
                        });
                    } else {
                        var fileURL = imguri;
                        function win(r) {
                            navigator.notification.alert("บันทึกข้อมูลเรียบร้อย", function () {
                                if (checkisNew()) {
                                    window.location.href = "dog_add.html?newDog=1&newRegis=1";
                                } else {
                                    var options = {
                                        "direction": "down",
                                        "duration": 500, // in milliseconds (ms), default 400
                                        "androiddelay": 10, // same as above but for Android, default 70,
                                        "href": "profile.html"
                                    };
                                    window.plugins.nativepagetransitions.slide(
                                            options
                                            );
                                }
                            }, "การแก้ไขข้อมูลผู้ใช้", "ตกลง");
                        }

                        function fail(error) {
                            alert("An error has occurred: Code = " + error.code);
                            console.log("upload error source " + error.source);
                            console.log("upload error target " + error.target);
                        }

                        var uri = encodeURI(api + "user/profile_update.php");
                        var options = new FileUploadOptions();
                        options.fileKey = "user_image";
                        options.fileName = fileURL.substr(fileURL.lastIndexOf('/') + 1);
                        options.mimeType = "image/jpeg";
                        options.params = {"token": $("#token").val(), "firstname": $("#firstname").val(), "lastname": $("#lastname").val(),
                            "houseno": $("#houseno").val(), "sub_district": $("#subdistrict_id").val(), "district": $("#district_id").val(),
                            "province": $("#province_id").val(), "postcode": $("#postcode").val(), "telno": $("#telno").val()};

                        var ft = new FileTransfer();
                        ft.onprogress = function (progressEvent) {
                            if (progressEvent.lengthComputable) {
                                console.log(progressEvent.loaded / progressEvent.total);
                                $(".progress-bar").css("width", (progressEvent.loaded / progressEvent.total) * 100 + "%");
                            }
                        };
                        ft.upload(fileURL, uri, win, fail, options);
                        $("#loader").fadeIn(500);
                    }
                    return false;  //stop the actual form post !important!
                });


                function checkisNew() {
                    var field = 'newAccount';
                    var url = window.location.href;
                    if (url.indexOf('?' + field + '=') != -1)
                        return true;
                    else if (url.indexOf('&' + field + '=') != -1)
                        return true;
                    return false;
                }

                $("#cancelbtn").on("click", function (e) {
                    function onConfirm(buttonIndex) {
                        if (buttonIndex == 2) {
                            var options = {
                                "direction": "down",
                                "duration": 500, // in milliseconds (ms), default 400
                                "androiddelay": 10, // same as above but for Android, default 70,
                                "href": "profile.html"
                            };
                            window.plugins.nativepagetransitions.slide(
                                    options
                                    );
                        }
                    }

                    navigator.notification.confirm(
                            'คุณแน่ใจว่าต้องการยกเลิกการแก้ไข และกลับไปหน้าก่อนหน้า', // message
                            onConfirm, // callback to invoke with index of button pressed
                            'การแก้ไขข้อมูลผู้ใช้', // title
                            ['ยกเลิก', 'ยืนยัน']     // buttonLabels
                            );
                });
            });
        </script>
    </body>

</html>