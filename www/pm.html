<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline' *; script-src 'self'  'unsafe-inline' 'unsafe-eval' *;">
        <meta name="viewport" content="width=device-width, user-scalable=no" />
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/css/navbar.css">
        <link rel="stylesheet" href="assets/css/dog.css">
        <link rel="stylesheet" href="assets/css/font/fonts.css">
        <link rel="stylesheet" href="assets/css/chat.css" />
        <link rel="stylesheet" href="assets/css/talkbubble.css" />
        <style>
            #mobilecontainer{
                width:100%;
                height:100%;
                position: fixed;
                top:0;
                left:0;
                border:none;
            }
            #messagelist{
                font-size: large;
                margin-top: 55px;
            }
            #messagecontainer{
                font-size: large;
            }
        </style>
    </head>
    <body>
        <div id="mobilecontainer">
            <div id="messagelist">
            </div>
            <div id="messagepage">
                <div id="messagehead">
                    <div id="backbtn"><</div>
                    <div id="messagename"></div>
                </div>
                <div id="messagecontainer">
                    <div id="messagebox">
                    </div>
                </div>
                <div id="messagebtn">
                    <div class="input-group">
                        <textarea id="messagetxt" rows="1" class="form-control"></textarea>
                        <span class="input-group-btn">
                            <button id="messagesubmit" class="btn btn-default" disabled>Send</button>
                        </span>    
                    </div>
                </div>
            </div>
        </div>
        <script src="cordova.js"></script>
        <script src="assets/js/jquery.js"></script>
        <script src="assets/js/jquery.transit.min.js"></script>
        <script src="assets/js/base.js"></script>
        <script src="assets/js/functions.js"></script>
        <script src="assets/js/autoload.js"></script>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <script>
            var messagelistTimeout, chatTimeout, lastMessageFetchObject, lastNewMessageObject, currentUsername, currentUserid;
            var isLoading = false;
            $(function () {
                setTitle("ข้อความส่วนตัว");
                displayName();
                setMenu("nav-pm");

                init();
                $("#messagelist").on("click", ".thread", function (e) {

                    var user_id = $(this).attr("data-userid");
                    curusername = $(this).attr("data-name");
                    goToMessage(user_id, curusername);

                });



                $("#messagebox").on("scroll", function (e) {
                    if (!isLoading) {
                        if ($(this).scrollTop() == 0) {
                            isLoading = true;
                            $("#messagebox").prepend("<div class='innerloader'><img src='loader.gif'></div>");
                            fetchMessage(lastMessageFetchObject.message_id);
                        }
                    }
                });

                $("#backbtn").on("click", function (e) {
                    $(".navbar").fadeIn(300);
                    setTimeout(function () {
                        $("#messagebox").html("");
                    }, 500);
                    $("#messagepage").fadeOut(500);
                    clearTimeout(chatTimeout);
                    chatMain();
                });




                $("#messagetxt").keyup(function (e) {
                    if ($(this).val().length == 0) {
                        $(this).css("height", "22px");
                        $("#messagesubmit").attr("disabled", "disabled");
                    } else {
                        $("#messagesubmit").removeAttr("disabled");
                    }
                    while ($(this).outerHeight() < this.scrollHeight + parseFloat($(this).css("borderTopWidth")) + parseFloat($(this).css("borderBottomWidth"))) {
                        $(this).height($(this).height() + 1);
                    }
                });

                $("#messagesubmit").on("click", function (e) {
                    var msg = $("#messagetxt").val();
                    $("#messagesubmit").attr("disabled", "disabled");
                    $("#messagetxt").focus();
                    $.ajax({
                        url: api + "pm/pm_send.php",
                        type: "POST",
                        data: {"token": token, "to_user_id": currentUserid, "message": msg},
                        dataType: "json",
                        success: function (data) {
                            if (data.result == "1") {
                                clearTimeout(chatTimeout);
                                fetchMessage();
                                $("#messagesubmit").removeAttr("disabled");
                                $(this).css("height", "22px");
                                $("#messagesubmit").attr("disabled", "disabled");
                                $("#messagetxt").val("");
                                $("#messagetxt").focus();
                            } else {
                                alert("error");
                            }
                        }
                    });

                });

                $("#messagetxt").on("focus", function (e) {
                    setTimeout(function () {
                        $("#messagebox").scrollTop($('#messagebox')[0].scrollHeight);
                    }, 300);
                });

            });

            function init() {
                $.ajax({
                    url: api + "auth/checklogin.php",
                    type: "POST",
                    data: {"token": token},
                    dataType: "json",
                    success: function (data) {
                        if (data.status == "1") {
                            userdata = data.userdata;
                            if (!checkisNew()) {
                                chatMain();
                            } else {
                                var user_id = getQueryVariable("user_id");
                                var username = getQueryVariable("username");
                                //chatMain();
                                goToMessage(user_id, username);
                            }
                        } else {
                            alert("Token Invalid !");
                        }
                    }
                });
            }


            function chatMain() {
                console.log("chatMain() has been called");
                $.ajax({
                    url: api + "pm/pm_threadshow.php",
                    type: "POST",
                    data: {"token": token},
                    dataType: "json",
                    success: function (data) {
                        $("#messagelist").html("");
                        if (data.length < 0) {
                            $("#messagelist").html("ยังไม่มีข้อความในขณะนี้");
                        } else {
                            $.each(data, function (i, thread) {
                                var output = "";
                                if (thread.isRead) {
                                    output += '<div class="thread" data-userid="' + thread.user.user_id + '" data-name="' + thread.user.firstname + ' ' + thread.user.lastname + '">';
                                } else {
                                    output += '<div class="thread unread" data-userid="' + thread.user.user_id + '" data-name="' + thread.user.firstname + ' ' + thread.user.lastname + '">';
                                }

                                output += '<div class="profileimg">';
                                if (thread.user.user_image == null | thread.user.user_image == "null" | thread.user.user_image === "") {
                                    output += '<img src="">';
                                } else {
                                    output += '<img src="' + userimage + thread.user.user_image + '">';
                                }
                                output += '</div>' +
                                        '<div class="messagedata">' +
                                        '<div class="sendername">' + thread.user.firstname + ' ' + thread.user.lastname + ' (ID:' + thread.user.user_id + ')</div>' +
                                        '<div class="lastmsg">' + truncateString(thread.last_message, 60) + '</div>' +
                                        '<div class="lasttime">' + thread.last_message_time + '</div>' +
                                        '</div>' +
                                        '</div>';
                                $("#messagelist").append(output);
                            });
                        }
                        $("#loader").fadeOut(200);
                        messagelistTimeout = setTimeout(chatMain, 1000);
                    }
                });
            }

            function goToMessage(user_id, curusername) {
                currentUsername = curusername;
                currentUserid = user_id;
                clearTimeout(messagelistTimeout);

                $("#messagename").html(currentUsername);
                $("#messagepage").fadeIn(500);

                if (user_id == "0") {
                    $("#messagesubmit").attr("disabled", "disabled");
                    $("#messagetxt").attr("disabled", "disabled");
                    $("#messagetxt").val("");
                } else {
                    $("#messagesubmit").attr("disabled", "disabled");
                    $("#messagetxt").removeAttr("disabled");
                    $("#messagetxt").val("");
                }

                $("#messagebox").html("");
                $("#messagebox").prepend("<div class='innerloader'><img src='loader.gif'></div>");
                fetchMessage();
            }

            function fetchMessage(lastmessageid) {
                $(".navbar").fadeOut(300);
                console.log("chatMain() has been called");
                isLoading = true;
                lastmessageid = lastmessageid || 0;
                $.ajax({
                    url: api + "pm/pm_show.php",
                    type: "POST",
                    data: {"token": token, "to_user_id": currentUserid, "lastmessage_id": lastmessageid},
                    dataType: "json",
                    success: function (data) {
                        isLoading = false;
                        $(".innerloader").remove();
                        if (data.length > 0) {
                            if (lastmessageid == 0) {
                                $("#messagebox").html("");
                                lastNewMessageObject = data[0];
                            }
                            data.reverse();
                            lastMessageFetchObject = data[0];
                            var output = "";
                            $.each(data, function (i, msg) {
                                if (msg.user_id == currentUserid) {
                                    //left (another person)
                                    output += '<div class="message messageleft">';
                                    output += '<div class="talknameleft">';
                                    output += currentUsername;
                                    output += '</div>';
                                    output += '<div class="talk-bubble tri-right left-top">';
                                    output += '<div class="talktext">';
                                    output += '<p>' + msg.message + '</p>';
                                    output += '</div>';
                                    output += '</div>';
                                    output += '<div class="talktimeleft">'+msg.message_time+'</div>';
                                    output += '</div>';
                                } else {
                                    //right (myself)
                                    output += '<div class="message messageright">';
                                    output += '<div class="talknameright">';
                                    output += userdata.firstname + ' ' + userdata.lastname;
                                    output += '</div>';
                                    output += '<div class="talk-bubble tri-right right-top">';
                                    output += '<div class="talktext">';
                                    output += '<p>' + msg.message + '</p>';
                                    output += '</div>';
                                    output += '</div>';
                                    output += '<div class="talktimeright">'+msg.message_time+'</div>';
                                    output += '</div>';
                                }
                            });
                            if (lastmessageid != 0) {
                                current_top_element = $("#messagebox").children().first();
                            }
                            $("#messagebox").prepend(output);
                            if (lastmessageid == 0) {
                                console.log("scroll to bottom!");
                                setTimeout(function () {
                                    $("#messagebox").scrollTop($('#messagebox')[0].scrollHeight + 1000);
                                }, 100);
                                chatTimeout = setTimeout(checkNewMessage, 3000);
                            } else {
                                var previous_height = current_top_element.offset().top;
                                $("#messagebox").scrollTop(previous_height);
                            }
                        }
                    }
                });
            }

            function checkNewMessage() {
                $.ajax({
                    url: api + "pm/pm_show.php",
                    type: "POST",
                    data: {"token": token, "to_user_id": currentUserid},
                    dataType: "json",
                    success: function (data) {
                        if (data.length > 0) {
                            if (data[0].message_id != lastNewMessageObject.message_id) {
                                fetchMessage();
                            } else {
                                chatTimeout = setTimeout(checkNewMessage, 3000);
                            }
                        }
                    }
                });
            }

            function truncateString(str, n) {
                return str.length > n ? str.substr(0, n - 1) + '&hellip;' : str;
            }

            //Get Query String from previous page
            function getQueryVariable(variable) {
                var query = window.location.search.substring(1);
                var vars = query.split('&');
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split('=');
                    if (decodeURIComponent(pair[0]) == variable) {
                        return decodeURIComponent(pair[1]);
                    }
                }
                console.log('Query variable %s not found', variable);
            }
            function checkisNew() {
                var field = 'newmessage';
                var url = window.location.href;
                if (url.indexOf('?' + field + '=') != -1)
                    return true;
                else if (url.indexOf('&' + field + '=') != -1)
                    return true;
                return false;
            }
        </script>
    </body>
</html>
