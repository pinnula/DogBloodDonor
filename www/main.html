<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline' *; script-src 'self'  'unsafe-inline' 'unsafe-eval' *;">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/jquerymobile/jquery.mobile-1.4.5.min.css">
        <link rel="stylesheet" href="assets/css/navbar.css">
        <link rel="stylesheet" href="assets/css/dog.css">
        <link rel="stylesheet" href="assets/css/font/fonts.css">
        <style>
            #detailpage{
                margin: 5% 7% 0 7%
            }
            #donatepage{
                margin: 5% 7% 0 7%
            }
        </style>
    </head>
    <body>
        <!--start navigator bar-->
        <div class="navbar navbar-color navbar-inverse navbar-fixed-top" role="navigation" id="slide-nav">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-toggle"> 
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="navbar-brand" style="color: white;font-size: 120%" href="#">เมนูหลัก</a>
                </div>
                <div id="slidemenu">


                    <div class="navbar-form navbar-right" role="form">

                        <div class="form-group" >
                            <div class="row">
                                <div class="col-xs-3 col-lg-5">
                                    <img src="assets/images/user.png" id="userimgtag" class="img-circle img-responsive" style="width: 35px;height:35px"/>
                                </div>
                                <div class="col-xs-9 col-lg-7">
                                    <div id="showname" style="color: white"></div>
                                </div>
                            </div> 
                        </div>

                        <div class="form-group" >

                            <a href="pm.html" style="text-decoration: none;color: white">
                                <img src="assets/images/chat2.png" class="ui-li-icon" style="width:30px"/> messages
                                <span class="badge" style="background-color: #c12e2a"></span></a>
                            <!--<button name="message" id="message" data-mini="true" >
                              Messages <span class="badge">4</span>
                            </button>-->
                        </div>
                    </div>

                    <ul class="nav navbar-nav">
                        <li><a href="index.html" style="font-size: 100%">หน้าหลัก</a></li>
                        <li class="dropdown"> 
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" style="font-size: 100%">ประวัติ<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="profile.html">ประวัติเจ้าของ</a></li>
                                <li><a href="dog_list.html">ประวัติสุนัข</a></li>
                            </ul>
                        </li>
                        <li class="dropdown"> 
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" style="font-size: 100%">ขอรับเลือด<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="request.html">ประกาศขอเลือด</a></li>
                                <li><a href="requestor_show.html">ติดต่อผู้บริจาค</a></li>
                                <li><a href="confirmList.html">ยืนยันผู้บริจาค</a></li>
                            </ul>
                        </li>
                        <li><a href="donor_status.html" style="font-size: 100%">สถานะ&ประวัติการบริจาค</a></li>
                        <li><a href="article_main.html" style="font-size: 100%">บทความ</a></li>
                        <li><a href="questionAnswer.html" style="font-size: 100%">ถาม/ตอบ</a></li>
                        <li><a href="setting.html" style="font-size: 100%">ตั้งค่า</a></li>

                        <li><a id="logout" href="#" style="font-size: 100%">ออกจากระบบ</a></li>
                    </ul>

                </div>
            </div>
        </div>

        <!--end navigator bar-->

        <div id="page-content">

            <div class="container" >

                <div style="height:250px; width:100%;" id="map_canvas">
                </div>
                <hr>
                <h2 class="no-margin-top"><b>ประกาศขอรับบริจาคเลือด</b></h2>

                <!--<p class="lead">Use this document as a way to quickly start any new project. All you get is this text and a mostly barebones HTML document.</p>-->

                <div id="content">
                    <ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
                        <li class="active"><a href="#all" data-toggle="tab" >ทั่วไป</a></li>
                        <li><a href="#er" data-toggle="tab">ฉุกเฉิน</a></li>
                        <li><a href="#blood" data-toggle="tab">กรุ๊ปเลือด</a></li>

                    </ul>
                    <div id="my-tab-content" class="tab-content">
                        <div class="tab-pane active" id="all">

                            <table class="table">

                                <br><tbody>
                                </tbody>
                            </table>
                        </div>


                        <div class="tab-pane" id="er">
                            <table class="table">
                                <br><tbody>
                                </tbody>
                            </table>
                        </div>


                        <div class="tab-pane" id="blood">

                            <label for="bloodgroup"></label>
                            <select name="bloodgroup" id="bloodgroup" class="form-control input-lg" style="font-size: 1em">
                                <option value="1" selected="selected">DEA 1.1</option>                        
                                <option value="2">DEA 1.2</option>
                                <option value="3">DEA 3</option>
                                <option value="4">DEA 4</option>
                                <option value="5">DEA 5</option>
                                <option value="6">DEA 6</option>
                                <option value="7">DEA 7</option>
                                <option value="8">DEA 8</option>
                                <option value="9">ไม่สามารถระบุได้</option>
                            </select>

                            <table class="table">
                                <br><tbody>
                                </tbody>
                            </table>
                        </div>

                    </div>

                </div>

                <!-- /.container -->
            </div>
            <div id="detailpage">
                <div><b>ข้อมูลสุนัขที่ขอรับบริจาคเลือด</b></div><hr>
                <div id="detailcontainer">
                </div>
                <div id="detailbtn" style="float: right">
                    <button id="todonatebtn" data-theme="b" data-inline="true" style="background-color: #ac2925;border-color:#ac2925 ">บริจาค</button>
                    <button id="backbtn" data-theme="b" data-inline="true" style="background-color: #ac2925;border-color:#ac2925 ">กลับ</button>
                </div>
            </div>

            <div id="donatepage">
                <div id="donatecontainer">
                    <h3 style="font-weight: bold">เลือกสุนัขที่ต้องการบริจาค</h3><br>
                    <select id="choosedog" style="color: black">
                    </select>
                    <div id="reason"></div>
                </div>
                <div id="donatebtn" style="float: right">
                    <button id="submitbtn" data-theme="b" data-inline="true" style="background-color: #ac2925;border-color:#ac2925" disabled>ตกลง</button>
                    <button id="cancelbtn" data-theme="b" data-inline="true" style="background-color: #ac2925;border-color:#ac2925">ยกเลิก</button>
                </div>
            </div>
        </div>
        <!-- /#page-content -->
        <div id="loader">
            <img src="assets/images/loader2.gif">
        </div>
        <script src="assets/js/jquery-2.1.3.min.js"></script>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
<!--        <script src="assets/jquerymobile/jquery.mobile-1.4.5.min.js"></script>-->
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="cordova_plugins.js"></script>
        <script type="text/javascript" src="assets/js/buttonhandler.js"></script>
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
        <script src="assets/js/navbar.js"></script>
        <script>
            $(function () {
                $.support.cors = true;
                $("a").attr('data-ajax', false);
                var token = window.localStorage.getItem("token");
                var userdata = JSON.parse(window.localStorage.getItem("userdata"));
                var request_id;

                $("#showname").html("<b>" + userdata.firstname + " " + userdata.lastname + "</b>");
                if (userdata.user_image != null) {
                    $("#userimgtag").attr("src", "https://dogblooddonor.in.th/api/userimage/" + userdata.user_image);
                } else {
                    $("#userimgtag").attr("src", "assets/images/user.png");
                }

                $("#detailpage").hide();
                $("#donatepage").hide();
                init();

                //Generate requests in tap pane
                function init() {
                    $("#all tbody").html("");
                    $("#er tbody").html("");
                    $("#blood tbody").html("");
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/announce.php',
                        dataType: 'json',
                        data: {"token": token},
                        success: function (data) {
                            for (var i = 0; i < data.all.length; i++) {
                                $("#all tbody").append('<tr class="rq" data-rqid="' + data.all[i].request_id + '"><td>' + data.all[i].created_time + '</td><td>' + data.all[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + data.all[i].bloodtype_name + ' ภายในวันที่ ' + data.all[i].duedate + '</td></tr>');
                            }
                            for (var i = 0; i < data.urgent.length; i++) {
                                $("#er tbody").append('<tr class="rq" data-rqid="' + data.urgent[i].request_id + '"><td>' + data.urgent[i].created_time + '</td><td>' + data.urgent[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + data.urgent[i].bloodtype_name + ' ภายในวันที่ ' + data.urgent[i].duedate + '</td></tr>');
                            }
                            for (var i = 0; i < data.byBloodType[0].requests.length; i++) {
                                $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[0].requests[i].request_id + '"><td>' + data.byBloodType[0].requests[i].created_time + '</td><td>' + data.byBloodType[0].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + data.byBloodType[0].requests[i].bloodtype_name + ' ภายในวันที่ ' + data.byBloodType[0].requests[i].duedate + '</td></tr>');
                            }
                            setTimeout(function () {
                                init();
                            }, 60000);
                        }
                    });
                }

                //Show requests order by bloodgroup
                $("#bloodgroup").on("change", function () {
                    var slgroup = $("#bloodgroup").val();
                    $("#blood tbody").html("");
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/announce.php',
                        dataType: 'json',
                        data: {"token": token},
                        success: function (data) {
                            var current = data.byBloodType;
                            if (slgroup == 1) {
                                for (var i = 0; i < data.byBloodType[0].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[0].requests[i].request_id + '"><td>' + current[0].requests[i].created_time + '</td><td>' + current[0].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[0].requests[i].bloodtype_name + 'ภายในวันที่ ' + current[0].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 2) {
                                for (var i = 0; i < data.byBloodType[1].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[1].requests[i].request_id + '"><td>' + current[1].requests[i].created_time + '</td><td>' + current[1].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[1].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[1].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 3) {
                                for (var i = 0; i < data.byBloodType[2].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[2].requests[i].request_id + '"><td>' + current[2].requests[i].created_time + '</td><td>' + current[2].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[2].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[2].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 4) {
                                for (var i = 0; i < data.byBloodType[3].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[3].requests[i].request_id + '"><td>' + current[3].requests[i].created_time + '</td><td>' + current[3].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[3].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[3].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 5) {
                                for (var i = 0; i < data.byBloodType[4].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[4].requests[i].request_id + '"><td>' + current[4].requests[i].created_time + '</td><td>' + current[4].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[4].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[4].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 6) {
                                for (var i = 0; i < data.byBloodType[5].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[5].requests[i].request_id + '"><td>' + current[5].requests[i].created_time + '</td><td>' + current[5].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[5].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[5].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 7) {
                                for (var i = 0; i < data.byBloodType[6].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[6].requests[i].request_id + '"><td>' + current[6].requests[i].created_time + '</td><td>' + current[6].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[6].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[6].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 8) {
                                for (var i = 0; i < data.byBloodType[7].requests.length; i++) {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[7].requests[i].request_id + '"><td>' + current[7].requests[i].created_time + '</td><td>' + current[7].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[7].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[7].requests[i].duedate + '</td></tr>');
                                }
                            }
                        }
                    });
                });

                //Show request detail
                $("#my-tab-content").on("click", ".rq", function () {
                    request_id = $(this).attr("data-rqid");
                    $(".container").hide();
                    $("#detailcontainer").html("");
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/get_requestdetail.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id},
                        success: function (data) {
                            $("#detailpage").fadeIn(500);
                            var detail = "";
                            if (data.requester_dog.dog_image != null && data.requester_dog.dog_image != "")
                                detail += '<img src="https://dogblooddonor.in.th/api/dogimage/' + data.requester_dog.dog_image + '"/><br>';
                            else
                                detail += '<img src="assets/images/pets17.png"/><br><br>';
                            detail += '<div class="row"><div class="col-xs-5"><b>ชื่อสุนัข </b></div><div class="col-xs-7"><span>' + data.requester_dog.dog_name + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>อาการ: </b></div><div class="col-xs-7"><span>' + data.symptoms + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>สถานที่นัด: </b></div><div class="col-xs-7"><span>' + data.place.place_name + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>วันที่สิ้นสุด: </b></div><div class="col-xs-7"><span>' + data.duedate + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>เจ้าของสุนัข: </b></div><div class="col-xs-7"><span>' + data.requester_userprofile.firstname + ' ' + data.requester_userprofile.lastname + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>หมู่เลือด: </b></div><div class="col-xs-7"><span>' + data.requester_dog.dog_bloodtype_name + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>ปริมาณเลือดที่ต้องการ: </b></div><div class="col-xs-7"><span>' + data.amount_volume + ' CC.</span></div></div>';
                            $("#detailcontainer").append(detail);
                        }
                    });
                });

                //!! Donate function !!
                $("#todonatebtn").on("click", function () {
                    $("#detailpage").hide();
                    $("#choosedog").empty();
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/get_requestdetail.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id},
                        success: function (data) {
                            $("#donatepage").fadeIn(500);
                            var option = '<option></option>';
                            for (var i = 0; i < data.dog_list.length; i++) {
                                option += '<option value="' + data.dog_list[i].dog_id + '">' + data.dog_list[i].dog_name + '</option>';
                            }
                            $("#choosedog").append(option);
                        }
                    });
                });

                //!! Donate function !! - choose dog and enabled/disabled donate button
                $("#choosedog").on("change", function () {
                    var dog_id = $("#choosedog").val();
                    $("#reason").html("");
                    $("#submitbtn").attr("disabled", "disabled");
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/get_requestdetail.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id},
                        success: function (data) {
                            if (data.donateable.status == true) {
                                for (var i = 0; i < data.dog_list.length; i++) {
                                    if (data.dog_list[i].dog_id == dog_id) {
                                        if (data.dog_list[i].isOkToDonate == true) {
                                            $("#submitbtn").removeAttr("disabled");
                                        } else {
                                            for (var j = 0; j < data.dog_list[i].reasons.length; j++) {
                                                $("#reason").append(data.dog_list[i].reasons[j] + ' ');
                                            }
                                        }
                                    }
                                }
                            } else {
                                for (var i = 0; i < data.donateable.reasons.length; i++) {
                                    $("#reason").append(data.donateable.reasons[i] + ' ');
                                }
                            }
                        }
                    });
                });

                //!! Donate function !! - confirm
                $("#submitbtn").on("click", function () {
                    var dog_id = $("#choosedog").val();
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/donate_confirm.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id, "dog_id": dog_id},
                        success: function (data) {
                            if (data.result == 1) {
                                alert("จองคิวบริจาคเรียบร้อยแล้วค่ะ");
                                window.location.href = "index.html";
                            } else {
                                alert("ไม่สามารถบริจาคได้ค่ะ");
                            }
                        }
                    });
                });

                $("#backbtn").on("click", function (e) {
                    $("#detailpage").hide();
                    $(".container").fadeIn(500);
                });

                $("#cancelbtn").on("click", function (e) {
                    $("#donatepage").hide();
                    $("#detailpage").fadeIn(500);
                });

                $("#logout").on("click", function (e) {
                    $("#loader").fadeIn(500);
                    $.ajax({
                        type: 'POST',
                        url: 'https://dogblooddonor.in.th/api/logout.php',
                        dataType: 'json',
                        data: {"token": token},
                        success: function (data) {
                            if (data.result == 1) {
                                window.localStorage.clear();
                                facebookConnectPlugin.logout();
                                document.location.href = "index.html";
                            } else {
                                alert("error");
                                $("#loader").fadeOut(500);
                            }
                        }
                    });
                });



                var mapOptions = {
                    zoom: 4,
                    center: new google.maps.LatLng(13.7563, 100.5018),
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    zoomControl: false,
                    disableDefaultUI: true
                }

                var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);



                var onSuccess = function (position) {
                    positiona = position;
                    var myLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    map.panTo(myLatLng);
                    map.setZoom(14);

                    marker = new google.maps.Marker({
                        map: map,
                        animation: google.maps.Animation.DROP,
                        position: myLatLng,
                        icon: 'assets/images/pin.png'
                    });
                };

                // onError Callback receives a PositionError object
                //
                function onError(error) {
                    alert('code: ' + error.code + '\n' +
                            'message: ' + error.message + '\n');
                }

                navigator.geolocation.getCurrentPosition(onSuccess, onError);
            });


        </script>
    </body>
</html>
