<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline' *; script-src 'self'  'unsafe-inline' 'unsafe-eval' *;">
        <meta name="viewport" content="width=device-width, user-scalable=no" />
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/css/navbar.css">
        <link rel="stylesheet" href="assets/css/dog.css">
        <link rel="stylesheet" href="assets/css/font/fonts.css">
        <style>
            #detailpage{
                margin: 5% 7% 0 7%
            }
            #donatepage{
                margin: 5% 7% 0 7%
            }
        </style>
    </head>
    <body>

        <div id="loader" style="opacity: 1;"><img src="assets/images/loader2.gif"></div>

        <div id="page-content">
            <div class="container" >
                <div style="height:250px; width:100%;" id="map_canvas">
                </div>
                <hr>
                <h2 class="no-margin-top"><b>ประกาศขอรับบริจาคเลือด</b></h2>
                <div id="content">
                    <ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
                        <li class="active"><a href="#all" data-toggle="tab" >ทั่วไป</a></li>
                        <li><a href="#er" data-toggle="tab">ฉุกเฉิน</a></li>
                        <li><a href="#blood" data-toggle="tab">กรุ๊ปเลือด</a></li>

                    </ul>
                    <div id="my-tab-content" class="tab-content">
                        <div class="tab-pane active" id="all">

                            <table class="table" id="atable">
                                <thead><tr><th class="col-xs-5">เวลาที่ประกาศ</th><th class="col-xs-7">รายละเอียด</th></tr></thead>
                                <br><tbody>
                                </tbody>
                            </table>
                            <!--                            หน้า: <select id="allpage"></select>-->
                        </div>


                        <div class="tab-pane" id="er">
                            <table class="table" id="btable">
                                <thead><tr><th class="col-xs-5">เวลาที่ประกาศ</th><th class="col-xs-7">รายละเอียด</th></tr></thead>
                                <br><tbody>
                                </tbody>
                            </table>
                            <!--                            หน้า: <select id="erpage"></select>-->
                        </div>


                        <div class="tab-pane" id="blood">

                            <label for="bloodgroup"></label>
                            <select name="bloodgroup" id="bloodgroup" class="form-control input-lg" style="font-size: 1em">
                                <option value="1" selected="selected">DEA 1.1</option>                        
                                <option value="2">DEA 1.2</option>
                                <option value="3">DEA 3</option>
                                <option value="4">DEA 4</option>
                                <option value="5">DEA 5</option>
                                <option value="6">DEA 6</option>
                                <option value="7">DEA 7</option>
                                <option value="8">DEA 8</option>
                                <option value="9">ไม่สามารถระบุได้</option>
                            </select>

                            <table class="table" id="ctable">
                                <thead><tr><th class="col-xs-5">เวลาที่ประกาศ</th><th class="col-xs-7">รายละเอียด</th></tr></thead>
                                <br><tbody>
                                </tbody>
                            </table>
                            <!--                            หน้า: <select id="bpage"></select>-->
                        </div>

                    </div>

                </div>

                <!-- /.container -->
            </div>
            <div id="detailpage">
                <div id="detailcontainer">
                </div><br>
                <div id="detailbtn" style="float: right">
                    <button class="btn btn-default" id="todonatebtn" style="background-color: #ac2925;color:white;font-size: 1em">บริจาค</button>
                    <button class="btn btn-default" id="backbtn" style="background-color: #ac2925;color: white;font-size: 1em">กลับ</button>
                </div>
            </div>

            <div id="donatepage">
                <div id="donatecontainer">
                    <h3 style="font-weight: bold">เลือกสุนัขที่ต้องการบริจาค</h3><br>
                    <select id="choosedog" class="form-control input-lg" style="font-size: 0.8em">
                    </select><br>
                    <div id="reason"></div><br>
                </div><br>
                <div id="donatebtn" style="float: right">
                    <button class="btn btn-default" id="submitbtn" style="background-color: #ac2925;color: white;font-size: 1em" disabled>ตกลง</button>
                    <button class="btn btn-default" id="cancelbtn" style="background-color: #ac2925;color: white;font-size: 1em">ยกเลิก</button>
                </div>
            </div>
        </div>
        <script src="cordova.js"></script>
        <script src="assets/js/jquery.js"></script>
        <script src="assets/js/jquery.transit.min.js"></script>
        <script src="assets/js/base.js"></script>
        <script src="assets/js/functions.js"></script>
        <script src="assets/js/autoload.js"></script>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
        <script>
            var markers = [];
            var request_id;
            $(document).ready(function (e) {
                removeLoader();
                setTitle("เมนูหลัก");
                displayName();
                setMenu("nav-main");
                setTimeout(setStatusBar, 2500);
                disableBackButton();

                $("#detailpage").hide();
                $("#donatepage").hide();
                init();


                //Generate requests in tap pane
                function init() {
                    $.ajax({
                        type: 'POST',
                        url: api + 'request/announce.php',
                        dataType: 'json',
                        data: {"token": token},
                        success: function (data) {

                            $("#all tbody").html("");
                            $("#er tbody").html("");
                            $("#blood tbody").html("");
                            
                            for (var i = 0; (i < data.all.length) && (i < 6); i++) {
                                if (data.all[i].isValid == "true") {
                                    $("#all tbody").append('<tr class="rq" data-rqid="' + data.all[i].request_id + '"><td class="col-xs-4">' + data.all[i].created_time + '</td><td class="col-xs-8">' + data.all[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + data.all[i].bloodtype_name + ' ภายในวันที่ ' + data.all[i].duedate + '</td></tr>');
                                }
                            }
                            for (var i = 0; (i < data.urgent.length) && (i < 6); i++) {
                                if (data.urgent[i].isValid == "true") {
                                    $("#er tbody").append('<tr class="rq" data-rqid="' + data.urgent[i].request_id + '"><td class="col-xs-4">' + data.urgent[i].created_time + '</td><td class="col-xs-8">' + data.urgent[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + data.urgent[i].bloodtype_name + ' ภายในวันที่ ' + data.urgent[i].duedate + '</td></tr>');
                                }
                            }
                            for (var i = 0; (i < data.byBloodType[0].requests.length) && (i < 6); i++) {
                                if (data.byBloodType[0].requests[i].isValid == "true") {
                                    $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[0].requests[i].request_id + '"><td class="col-xs-4">' + data.byBloodType[0].requests[i].created_time + '</td><td class="col-xs-8">' + data.byBloodType[0].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + data.byBloodType[0].requests[i].bloodtype_name + ' ภายในวันที่ ' + data.byBloodType[0].requests[i].duedate + '</td></tr>');
                                }
                            }
                            setTimeout(init, 3000);
                        }
                    });
                }

                //Show requests order by bloodgroup
                $("#bloodgroup").on("change", function () {
                    var slgroup = $("#bloodgroup").val();
                    $("#blood tbody").html("");
                    $.ajax({
                        type: 'POST',
                        url: api + 'request/announce.php',
                        dataType: 'json',
                        data: {"token": token},
                        success: function (data) {
                            var current = data.byBloodType;
                            if (slgroup == 1) {
                                for (var i = 0; i < data.byBloodType[0].requests.length; i++) {
                                    if (data.byBloodType[0].requests[i].isValid == "true")
                                        $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[0].requests[i].request_id + '"><td class="col-xs-4">' + current[0].requests[i].created_time + '</td><td class="col-xs-8">' + current[0].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[0].requests[i].bloodtype_name + 'ภายในวันที่ ' + current[0].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 2) {
                                for (var i = 0; i < data.byBloodType[1].requests.length; i++) {
                                    if (data.byBloodType[1].requests[i].isValid == "true")
                                        $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[1].requests[i].request_id + '"><td class="col-xs-4">' + current[1].requests[i].created_time + '</td><td class="col-xs-8">' + current[1].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[1].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[1].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 3) {
                                for (var i = 0; i < data.byBloodType[2].requests.length; i++) {
                                    if (data.byBloodType[2].requests[i].isValid == "true")
                                        $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[2].requests[i].request_id + '"><td class="col-xs-4">' + current[2].requests[i].created_time + '</td><td class="col-xs-8">' + current[2].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[2].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[2].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 4) {
                                for (var i = 0; i < data.byBloodType[3].requests.length; i++) {
                                    if (data.byBloodType[3].requests[i].isValid == "true")
                                        $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[3].requests[i].request_id + '"><td class="col-xs-4">' + current[3].requests[i].created_time + '</td><td class="col-xs-8">' + current[3].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[3].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[3].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 5) {
                                for (var i = 0; i < data.byBloodType[4].requests.length; i++) {
                                    if (data.byBloodType[4].requests[i].isValid == "true")
                                        $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[4].requests[i].request_id + '"><td class="col-xs-4">' + current[4].requests[i].created_time + '</td><td class="col-xs-8">' + current[4].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[4].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[4].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 6) {
                                for (var i = 0; i < data.byBloodType[5].requests.length; i++) {
                                    if (data.byBloodType[5].requests[i].isValid == "true")
                                        $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[5].requests[i].request_id + '"><td class="col-xs-4">' + current[5].requests[i].created_time + '</td><td class="col-xs-8">' + current[5].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[5].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[5].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 7) {
                                for (var i = 0; i < data.byBloodType[6].requests.length; i++) {
                                    if (data.byBloodType[6].requests[i].isValid == "true")
                                        $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[6].requests[i].request_id + '"><td class="col-xs-4">' + current[6].requests[i].created_time + '</td><td class="col-xs-8">' + current[6].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[6].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[6].requests[i].duedate + '</td></tr>');
                                }
                            } else if (slgroup == 8) {
                                for (var i = 0; i < data.byBloodType[7].requests.length; i++) {
                                    if (data.byBloodType[7].requests[i].isValid == "true")
                                        $("#blood tbody").append('<tr class="rq" data-rqid="' + data.byBloodType[7].requests[i].request_id + '"><td class="col-xs-4">' + current[7].requests[i].created_time + '</td><td class="col-xs-8">' + current[7].requests[i].dog_name + ' ต้องการเลือดกรุ๊ป ' + current[7].requests[i].bloodtype_name + ' ภายในวันที่ ' + current[7].requests[i].duedate + '</td></tr>');
                                }
                            }
                        }
                    });
                });

                //Show request detail
                $("#my-tab-content").on("click", ".rq", function () {
                    request_id = $(this).attr("data-rqid");
                    $(".container").hide();
                    $("#detailcontainer").html("");
                    $.ajax({
                        type: 'POST',
                        url: api + 'request/getdetails.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id},
                        success: function (data) {
                            $("#detailpage").fadeIn(500);
                            var detail = "";
                            if (data.requester_dog.dog_image != null && data.requester_dog.dog_image != "")
                                detail += '<img class="img-thumbnail img-circle" style="width: 200px;height: 200px" src="https://dogblooddonor.in.th/api/dogimage/' + data.requester_dog.dog_image + '"/><br>';
                            else
                                detail += '<img src="assets/images/pets17.png"/><br><br>';
                            detail += '<div class="row"><div class="col-xs-7"><b>' + 'ข้อมูลสุนัขที่ขอรับเลือด' + '</b></div>' +
                                    '<div class="col-xs-5"><a data-ajax="false" href="pm.html?newmessage=1&user_id=' + data.requester_userprofile.user_id + '&username=' + data.requester_userprofile.firstname + ' ' + data.requester_userprofile.lastname + '"><button class="btn btn-default" style="font-size: 0.9em;background-color: #e2e2e2">' + 'ติดต่อเจ้าของ' + '</button></a></div><br><hr></div>';
                            detail += '<div class="row"><div class="col-xs-5"><b>ชื่อสุนัข </b></div><div class="col-xs-7"><span>' + data.requester_dog.dog_name + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>อาการ: </b></div><div class="col-xs-7"><span>' + data.symptoms + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>สถานที่นัด: </b></div><div class="col-xs-7"><span>' + data.place.place_name + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>วันที่สิ้นสุด: </b></div><div class="col-xs-7"><span>' + data.duedate + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>เจ้าของสุนัข: </b></div><div class="col-xs-7"><span>' + data.requester_userprofile.firstname + ' ' + data.requester_userprofile.lastname + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>หมู่เลือด: </b></div><div class="col-xs-7"><span>' + data.requester_dog.dog_bloodtype_name + '</span></div></div>' +
                                    '<div class="row"><div class="col-xs-5"><b>ปริมาณเลือดที่ต้องการ: </b></div><div class="col-xs-7"><span>' + data.amount_volume + ' CC.</span></div></div>';
                            $("#detailcontainer").append(detail);
                            if (data.donateable.status == false) {
                                $("#todonatebtn").attr("disabled", "disabled");
                                $("#detailcontainer").append('<div style="color: red">' + data.donateable.reasons + '</div>');
                            } else {
                                $("#todonatebtn").removeAttr("disabled", "disabled");
                            }
                        }
                    });
                });

                //!! Donate function !!
                $("#todonatebtn").on("click", function () {
                    $("#detailpage").hide();
                    $("#choosedog").empty();
                    $.ajax({
                        type: 'POST',
                        url: api + 'request/getdetails.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id},
                        success: function (data) {
                            $("#donatepage").fadeIn(500);
                            var option = '<option style="display:none;">--โปรดระบุ--</option>';
                            for (var i = 0; i < data.dog_list.length; i++) {
                                if (data.dog_list[i].isOkToDonate) {
                                    option += '<option value="' + data.dog_list[i].dog_id + '">' + data.dog_list[i].dog_name + '</option>';
                                } else {
                                    option += '<option disabled value="' + data.dog_list[i].dog_id + '">' + data.dog_list[i].dog_name + '</option>';
                                }
                            }
                            $("#choosedog").append(option);
                        }
                    });
                });

                //!! Donate function !! - choose dog and enabled/disabled donate button
                $("#choosedog").on("change", function () {
                    var dog_id = $("#choosedog").val();
                    $("#reason").html("");
                    $("#submitbtn").attr("disabled", "disabled");
                    $.ajax({
                        type: 'POST',
                        url: api + 'request/getdetails.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id},
                        success: function (data) {
                            if (data.donateable.status == true) {
                                for (var i = 0; i < data.dog_list.length; i++) {
                                    if (data.dog_list[i].dog_id == dog_id) {
                                        if (data.dog_list[i].isOkToDonate == true) {
                                            $("#submitbtn").removeAttr("disabled");
                                        } else {
                                            for (var j = 0; j < data.dog_list[i].reasons.length; j++) {
                                                $("#reason").append(data.dog_list[i].reasons[j] + ' ');
                                            }
                                        }
                                    }
                                }
                            } else {
                                for (var i = 0; i < data.donateable.reasons.length; i++) {
                                    $("#reason").append(data.donateable.reasons[i] + ' ');
                                }
                            }
                        }
                    });
                });

                //!! Donate function !! - confirm
                $("#submitbtn").on("click", function () {
                    var dog_id = $("#choosedog").val();
                    $.ajax({
                        type: 'POST',
                        url: api + 'donate/donate_confirm.php',
                        dataType: 'json',
                        data: {"token": token, "request_id": request_id, "dog_id": dog_id},
                        success: function (data) {
                            if (data.result == 1) {
                                alert("จองคิวบริจาคเรียบร้อยแล้วค่ะ");
                                window.location.href = "main.html";
                            } else {
                                alert("ไม่สามารถบริจาคได้ค่ะ");
                            }
                        }
                    });
                });

                $("#backbtn").on("click", function (e) {
                    $("#detailpage").hide();
                    $(".container").fadeIn(500);
                });

                $("#cancelbtn").on("click", function (e) {
                    $("#donatepage").hide();
                    $("#detailpage").fadeIn(500);
                });


                //main map
                map = new google.maps.Map(document.getElementById("map_canvas"), {
                    zoom: 4,
                    center: new google.maps.LatLng(13.7563, 100.5018),
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    zoomControl: false,
                    disableDefaultUI: true
                });
                navigator.geolocation.getCurrentPosition(onSuccess, onError);
            }); //end document ready


            //maps functions
            var onSuccess = function (position) {
                positiona = position;
                var myLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                map.panTo(myLatLng);
                map.setZoom(14);
                marker = new google.maps.Marker({
                    map: map,
                    animation: google.maps.Animation.DROP,
                    position: myLatLng,
                    icon: 'assets/images/pin.png'
                });
                markers.push(marker);
                getNearByHospital(position.coords.latitude, position.coords.longitude);
            };

            function onError(error) {
                alert('code: ' + error.code + '\n' +
                        'message: ' + error.message + '\n');
            }

            var bindInfoWindow = function (marker, map, infowindow, html) {
                google.maps.event.addListener(marker, 'click', function () {
                    infowindow.setContent(html);
                    infowindow.open(map, marker);
                });
            }

            function getNearByHospital(lat, lng) {
                $.ajax({
                    type: 'POST',
                    url: api + "/place/",
                    data: {"lat": lat, "long": lng, "query": "สัตว์"},
                    dataType: "json",
                    success: function (data) {
                        $.each(data, function (i, hospital) {
                            var loca = {lat: parseFloat(hospital.geolocation.lat), lng: parseFloat(hospital.geolocation.long)};
                            var marker = new google.maps.Marker({
                                map: map,
                                position: loca,
                                title: hospital.name,
                                icon: "assets/images/pin_hospital.png",
                                animation: google.maps.Animation.DROP
                            });
                            var infowindow = new google.maps.InfoWindow({
                                content: ''
                            });
                            var distance = hospital.distance.replace("km", "กิโลเมตร");
                            distance = distance.replace("m", "เมตร");
                            var output = '<b>' + hospital.name + "</b><br>" + hospital.address + "<br>";
                            if (hospital.phone != "") {
                                output += "เบอร์โทรศัพท์ : <a href='tel:" + hospital.phone + "'>" + hospital.phone + "</a><br>";
                            }
                            output += "ระยะห่างจากคุณ : " + distance;
                            bindInfoWindow(marker, map, infowindow, output);
                            markers.push(marker);
                        });
                    }
                });
            }

        </script>
    </body>
</html>
